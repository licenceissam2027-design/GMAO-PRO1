@extends('layouts.app')
@section('content')
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">{{ __('gmao.maintenance.plans') }}</h5>
        <div class="d-flex align-items-center gap-2">
            <a class="action-icon" href="{{ route('maintenance.plans.create') }}"><i class="bi bi-shield-plus"></i><span>{{ __('gmao.common.add') }}</span></a>
            <form method="GET" class="d-flex gap-1"><select class="form-select form-select-sm" name="sector"><option value="">{{ __('gmao.common.all_sectors') }}</option>@foreach($sectors as $sector)<option value="{{ $sector }}" @selected($selectedSector === $sector)>{{ __('gmao.enum.sector.'.$sector) }}</option>@endforeach</select><button class="btn btn-sm btn-outline-secondary">{{ __('gmao.common.search') }}</button></form>
        </div>
    </div>
    <div class="table-responsive"><table class="table table-sm align-middle"><thead><tr><th>{{ __('gmao.common.title') }}</th><th>{{ __('gmao.common.reference') }}</th><th>{{ __('gmao.common.sector') }}</th><th>{{ __('gmao.maintenance.domain') }}</th><th>{{ __('gmao.maintenance.failure_mode') }}</th><th>{{ __('gmao.common.frequency') }}</th><th>{{ __('gmao.maintenance.estimated_duration') }}</th><th>{{ __('gmao.common.date') }}</th><th>{{ __('gmao.common.status') }}</th><th>{{ __('gmao.common.actions') }}</th></tr></thead><tbody>
    @forelse($plans as $p)<tr><td>{{ $p->title }}</td><td>{{ $p->asset_reference ?: '-' }}</td><td>{{ $p->sector ? __('gmao.enum.sector.'.$p->sector) : '-' }}</td><td>{{ $p->maintenance_domain ? ($domainLabels[$p->maintenance_domain] ?? $p->maintenance_domain) : '-' }}</td><td>{{ $p->failure_mode ? ($failureModeLabels[$p->failure_mode] ?? $p->failure_mode) : '-' }}</td><td>{{ ($p->interval_value ?? 1) }} x {{ __('gmao.enum.type.'.$p->frequency) }}</td><td>{{ $p->estimated_duration_minutes ? ($p->estimated_duration_minutes.' min') : '-' }}</td><td>{{ $p->next_due_date }}</td><td>{{ $p->is_active ? __('gmao.enum.status.active') : __('gmao.enum.status.stopped') }}</td><td><a class="btn btn-sm btn-outline-success" href="{{ route('assets.reports.create', ['context_type' => 'preventive_plan', 'context_id' => $p->id]) }}"><i class="bi bi-file-earmark-plus"></i></a> <a class="btn btn-sm btn-outline-info" href="{{ route('assets.reports', ['context_type' => 'preventive_plan', 'context_id' => $p->id]) }}"><i class="bi bi-files"></i></a>
    @can('update', $p)<details><summary class="btn btn-sm btn-outline-primary">{{ __('gmao.common.edit') }}</summary><form method="POST" action="{{ route('maintenance.plans.update', $p) }}" class="vstack gap-1 mt-1">@csrf @method('PATCH')
    <input class="form-control form-control-sm" name="title" value="{{ $p->title }}" required><select class="form-select form-select-sm" name="sector"><option value="">{{ __('gmao.common.sector') }}</option>@foreach($sectors as $sector)<option value="{{ $sector }}" @selected($p->sector === $sector)>{{ __('gmao.enum.sector.'.$sector) }}</option>@endforeach</select><select class="form-select form-select-sm" name="asset_type">@foreach(['industrial','technical','logistic','other'] as $t)<option value="{{ $t }}" @selected($p->asset_type === $t)>{{ __('gmao.enum.type.'.$t) }}</option>@endforeach</select><input class="form-control form-control-sm" name="asset_reference" value="{{ $p->asset_reference }}"><select class="form-select form-select-sm" name="frequency">@foreach(['daily','weekly','monthly','quarterly','yearly'] as $f)<option value="{{ $f }}" @selected($p->frequency === $f)>{{ __('gmao.enum.type.'.$f) }}</option>@endforeach</select><input class="form-control form-control-sm" type="number" min="1" max="365" name="interval_value" value="{{ $p->interval_value ?? 1 }}" required><select class="form-select form-select-sm" name="trigger_mode">@foreach(['calendar','meter','both'] as $tm)<option value="{{ $tm }}" @selected(($p->trigger_mode ?? 'calendar') === $tm)>{{ __('gmao.enum.trigger.'.$tm) }}</option>@endforeach</select><input class="form-control form-control-sm" type="number" step="0.01" min="0" name="meter_threshold" value="{{ $p->meter_threshold }}"><input class="form-control form-control-sm" type="number" min="5" max="1440" name="estimated_duration_minutes" value="{{ $p->estimated_duration_minutes }}"><select class="form-select form-select-sm" name="skill_level">@foreach(['operator','technician','senior_technician','specialist'] as $skill)<option value="{{ $skill }}" @selected(($p->skill_level ?? 'technician') === $skill)>{{ __('gmao.enum.skill.'.$skill) }}</option>@endforeach</select><input class="form-control form-control-sm" type="date" name="next_due_date" value="{{ $p->next_due_date }}" required><input class="form-control form-control-sm" type="date" name="last_done_date" value="{{ $p->last_done_date }}"><select class="form-select form-select-sm" name="responsible_id"><option value="">{{ __('gmao.projects.manager') }}</option>@foreach($users as $u)<option value="{{ $u->id }}" @selected($p->responsible_id === $u->id)>{{ $u->name }}</option>@endforeach</select><select class="form-select form-select-sm" name="maintenance_domain"><option value="">{{ __('gmao.maintenance.domain') }}</option>@foreach($maintenanceDomains as $domain)<option value="{{ $domain }}" @selected($p->maintenance_domain === $domain)>{{ $domainLabels[$domain] ?? $domain }}</option>@endforeach</select><select class="form-select form-select-sm" name="failure_mode"><option value="">{{ __('gmao.maintenance.failure_mode') }}</option>@foreach($failureModes[$p->maintenance_domain] ?? [] as $mode)<option value="{{ $mode }}" @selected($p->failure_mode === $mode)>{{ $failureModeLabels[$mode] ?? $mode }}</option>@endforeach</select><textarea class="form-control form-control-sm" name="checklist">{{ $p->checklist }}</textarea><textarea class="form-control form-control-sm" name="procedure_steps">{{ $p->procedure_steps }}</textarea><textarea class="form-control form-control-sm" name="safety_notes">{{ $p->safety_notes }}</textarea><textarea class="form-control form-control-sm" name="spare_parts_list">{{ $p->spare_parts_list }}</textarea><div class="form-check"><input class="form-check-input" type="checkbox" name="requires_shutdown" value="1" @checked($p->requires_shutdown)><label class="form-check-label">{{ __('gmao.maintenance.requires_shutdown') }}</label></div><div class="form-check"><input class="form-check-input" type="checkbox" name="is_active" value="1" @checked($p->is_active)><label class="form-check-label">{{ __('gmao.common.active') }}</label></div><button class="btn btn-sm btn-primary">{{ __('gmao.common.update') }}</button></form></details>@endcan
    @can('delete', $p)<form method="POST" action="{{ route('maintenance.plans.destroy', $p) }}" class="mt-1" onsubmit="return confirm('{{ __('gmao.common.confirm_delete') }}')">@csrf @method('DELETE')<button class="btn btn-sm btn-outline-danger">{{ __('gmao.common.delete') }}</button></form>@endcan
    </td></tr>
    @empty <tr><td colspan="10" class="text-center">{{ __('gmao.common.none') }}</td></tr> @endforelse
    </tbody></table></div>{{ $plans->links() }}
</div>
@endsection
